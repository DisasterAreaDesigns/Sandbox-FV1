<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandbox FV-1 Editor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,0,1;wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">

        <!-- Monaco Editor Loader -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
        <script src="monaco.js"></script>

        <div class="header-bar">
            <div class="header-content">
                <h1>Sandbox FV-1 Editor</h1>
            </div>
            <div class="icon-container">
                <a href="https://sandboxpedal.com" target="_blank" rel="noopener noreferrer">
                    <svg class="app-icon" width="64" height="64" viewBox="0 0 64 64">
                        <rect width="64" height="64" rx="4" ry="4" fill="currentColor"/>
                        <text x="32" y="40" text-anchor="middle" fill="white" font-family="League Spartan" font-size="20" font-weight="bold">FV1</text>
                    </svg>
                </a>
                <span class="build">build 16</span>
            </div>
        </div>

        <h2>Source Input</h2>
        <div class="file-input">
            <input type="file" id="fileInput" accept=".asm,.txt,.spn" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <input type="file" id="fileInput" accept=".spn,.asm,.txt" style="display: none;" onchange="handleFileInputChange()">
                <button onclick="loadFile()">Load File...</button>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>Or select an example program:</span>
                    <button onclick="loadExample('passthrough')">Pass-through</button>
                    <button onclick="loadExample('delay')">Delay</button>
                    <button onclick="loadExample('chorus')">Chorus</button>
                    <button onclick="loadExample('tremolo')">Tremolo</button>
                </div>
            </div>
        </div>

        <div class="editor-container">
            <div id="editor" style="width: 100%; height: 400px;"></div>
        </div>

        <!-- Editor Options Section -->
        <div class="editor-options-section">
            <h3 onclick="toggleEditorOptions()" style="cursor: pointer; user-select: none; margin-bottom: 10px;">
                <span id="editorOptionsToggle">▶</span> Editor Options
            </h3>
            <div id="editorOptionsContent" class="editor-options-content collapsed">
                <div class="options">
                    <div class="project-folder-section">
                        <button id="projectFolderBtn" class="project-folder-button" onclick="selectProjectDirectory()">
                            Select Project Folder
                        </button>
                        <span id="projectFolderLabel" style="margin-left: 10px; color: #666; font-style: italic;">No directory selected</span>
                    </div><br>
                    <label>
                        <input type="checkbox" id="editorHeightToggle" onchange="toggleEditorHeightWithSave()"> Large editor window
                    </label>
                    <label>
                        <input type="checkbox" id="minimapToggle" onchange="toggleMinimapWithSave()"> Show editor mini-map
                    </label>
                    <label>
                        <input type="checkbox" id="debugToggle" onchange="toggleDebugPresetWithSave()"> Show full build results
                    </label>
                    <label>
                        Theme: 
                        <select id="darkModeSelect">
                            <option value="system">System</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </label>
                </div>
                <div class="editor-help-text">
                    <label>
                        <span class="shortcut">Editor Shortcuts active when cursor is in editor window:</span>
                        <span class="shortcut">Ctrl+F / ⌘+F Find</span>
                        <span class="shortcut">Ctrl+Shift+F / ⌘+⌥+F Replace</span>
                        <span class="shortcut">F3 Find Next</span>
                    </label><br>
                    <label>
                        <span class="shortcut">Editor accepts ASCII text only</span>
                    </label>
                </div>
            </div>
        </div>

        <div>
            <button onclick="assemble()">Assemble</button>
            <button onclick="downloadPlainHex()" id="downloadPlainHexBtn" disabled>Download HEX</button>
            <button onclick="downloadBinary()" id="downloadBinBtn" disabled>Download Binary</button>
            <button onclick="downloadCHeader()" id="downloadCHeaderBtn" disabled>Download C Headers</button>
            <button onclick="saveSource()">Save Source...</button>
            <div style="float: right;">
                <button onclick="clearEditor()">Clear Editor</button>
            </div>
        </div>

        <h2>Build Results</h2>
        <div id="messages" style="display: block; min-height: 100px;"></div>

        <!-- Hardware Options Section -->
        <div class="hardware-options-section">
            <h3 onclick="toggleHardwareOptions()" style="cursor: pointer; user-select: none; margin-bottom: 10px;">
                <span id="hardwareOptionsToggle">▶</span> Hardware Options
                <span id="hardwareConnectionStatus" style="font-weight: normal; color: #666; margin-left: 10px; font-size: 0.9em;">No connection</span>
            </h3>
            <div id="hardwareOptionsContent" class="hardware-options-content collapsed">
                <div class="output-controls">
                    <div>
                        <button onclick="selectOutputDirectory()" id="selectDirBtn">Select Output Directory</button>
                        <span id="outputDirDisplay" style="margin-left: 10px; color: #666; font-style: italic;">No directory selected</span>
                    </div><br />
                    <div>
                        <button onclick="serialConnect()">Select Serial Port</button>
                        <span id="serialPortDisplay" style="margin-left: 10px; color: #666; font-style: italic;">No port selected</span>
                    </div>
                    <!-- Filename / Toggle Position Grid -->
                    <div style="margin-top: 10px;">
                        Filename / Toggle Position:
                        <span id="filenameLabel" style="font-weight: bold; margin-left: 5px; color: #333;">(none selected)</span>
                        <div class="button-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-top: 6px;">
                            <button class="filename-btn" data-filename="2.hex" onclick="selectFilename(this)">↑ 2 ↑</button>
                            <button class="filename-btn" data-filename="6.hex" onclick="selectFilename(this)">↑ 6 ↓</button>
                            <button class="filename-btn" data-filename="3.hex" onclick="selectFilename(this)">◉ 3 ↑</button>
                            <button class="filename-btn" data-filename="7.hex" onclick="selectFilename(this)">◉ 7 ↓</button>
                            <button class="filename-btn" data-filename="1.hex" onclick="selectFilename(this)">↓ 1 ↑</button>
                            <button class="filename-btn" data-filename="5.hex" onclick="selectFilename(this)">↓ 5 ↓</button>
                            <button class="filename-btn" data-filename="0.hex" onclick="selectFilename(this)">0 (BYPASS)</button>
                            <button class="filename-btn" data-filename="4.hex" onclick="selectFilename(this)">4 (Not Used)</button>
                        </div>
                        <br>
                        ↑ = switch up, ◉ = switch mid, ↓ = switch down
                    </div>
                </div>
            </div>
        </div>

        <div class="download-buttons">
            <button onclick="downloadHex()" id="downloadHexBtn" disabled>Download to Hardware</button>
            <button onclick="clearHardware()" id="clearHardwareBtn" disabled>Clear Hardware</button>
            <div style="float: right;">
                <button onclick="clearAssembly()" id="clearResultsBtn">Clear Results</button>
            </div>
        </div>

        <div class="output-text-section">
            <h3 onclick="toggleOutput()" style="cursor: pointer; user-select: none; margin-bottom: 10px;">
                <span id="outputToggle">▶</span> Assembly Output
            </h3>
            <div id="outputContent" class="output-content collapsed">
                <textarea id="output" readonly placeholder="FV-1 assembly output will appear here..."></textarea>
            </div>
        </div>

        <div class="instructions-section">
            <h3 onclick="toggleInstructions()" style="cursor: pointer; user-select: none; margin-bottom: 10px;">
                <span id="instructionsToggle">▶</span> Instructions & Help
            </h3>
            <div id="instructionsContent" class="instructions-content collapsed">
                <div class="instructions-text">
                    <div>
                        <h4>Getting Started</h4>
                        <p>This web application is designed to assemble SpinASM source code into machine instructions for the FV-1 DSP chip. Generated machine code may be saved locally for later use, or sent to a <b>Sandbox FV1</b> hardware target to hear the results.</p>
                        <ul>
                            <li><i>Enter SpinASM source code into the editor area, or select a file or example. Press the <b>Assemble</b> button to verify and assemble the code into a HEX file</i></li>
                            <li><i>Press the <b>Download HEX</b> to save the resulting HEX file to your local Downloads folder. Check the <b>Build Results</b> for success or error messages.</i></li>
                            <li><i><b>Download Binary</b> and <b>Download C Headers</b> output the assembled data in alternate format for use with more advanced applications and are not used with <b>Sandbox FV1</b> hardware</i></li>
                            <li><i>When satisfied with your source code, press the <b>Save Source...</b> button to download a local copy.</i></li>
                        </ul>
                        <h4>Connecting to Hardware</h4>
                        <p><i>Connect your <b>Sandbox FV1</b> pedal to your computer using a suitable USB cable. A new removable drive labeled <b>SANDBOX-FV1</b> should appear.</i></p>
                        <ul>
                            <li>Open the <b>Hardware Options</b> section to <b>Select Output Directory</b> button to specify the path to your <b>Sandbox FV1</b> (typically /SANDBOX-FV1).</li>
                            <li><i>Use the <b>Filename / Toggle Position</b> buttons to select the destination slot on your hardware device</i></li>
                            <li><i>Press the <b>Download to Hardware</b> button to save your algorithm to the <b>Sandbox FV1</b> hardware unit</i></li>
                        </ul>
                        <h4>Troubleshooting</h4>
                        <p>Errors and warnings will appear in the Build Results window and are often helpful for troubleshooting. Scroll up to the top to see previous messages</p>
                        <ul>
                            <li>Error information not helpful - use <b>Editor Options - Show full build results</b> to see more detailed info</li>
                            <li>File transfer problems - <i>ensure proper directory permissions</i></li>
                            <li>Assembly errors - <i>check syntax and register usage</i></li>
                            <li>Connection issues - <i>verify USB cable and folder selection</i></li>
                        </ul>
                        <h4>What do these Options do?</h4>
                        <p>These are some settings that change various editor settings</p>
                        <ul>
                            <h3>Editor Options</h3>
                            <li>Select Project Folder: <i>Choose path to save HEX, binary, header, and source files</i></li>
                            <li>Large editor window: <i>Expands editor text area to show more instructions</i></li>
                            <li>Theme: <i>Use light, dark, or system color theme</i></li>
                            <li>Show editor mini-map: <i>Show a small navigation map in editor</i></li>
                            <li>Show full build results: <i>Show complete debug information in <b>Build Results</b> window</i></li>
                        </ul>
                        <ul>
                            <h3>Hardware Options</h3>
                            <li>Select Output Directory: <i>Specify the folder location of your <b>Sandbox FV</b> hardware (typically /SANDBOX-FV1)</i></li>
                            <li>Filename / Toggle Position: <i>Select the destination slot on your hardware device</i></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal dialogs for user prompts -->
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <h3 id="confirmTitle">Confirm Action</h3>
                <p id="confirmMessage">Are you sure you want to proceed?</p>
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
                    <button class="btn-primary" id="confirmOkBtn">OK</button>
                </div>
            </div>
        </div>

        <div id="threeChoiceModal" class="modal">
            <div class="modal-content">
                <h3 id="threeChoiceTitle">Unsaved Changes</h3>
                <p id="threeChoiceMessage">You have unsaved changes. What would you like to do?</p>
                <div class="modal-buttons">
                    <button class="btn-secondary" id="threeChoiceCancelBtn">Cancel</button>
                    <button class="btn-danger" id="threeChoiceDiscardBtn">Discard</button>
                    <button class="btn-primary" id="threeChoiceSaveBtn">Save</button>
                </div>
            </div>
        </div>

        <div id="inputModal" class="modal">
            <div class="modal-content">
                <h3 id="inputTitle">Input Required</h3>
                <label for="modalInput" id="inputLabel">Please enter a value:</label>
                <input type="text" id="modalInput" placeholder="Enter value...">
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="closeModal('inputModal')">Cancel</button>
                    <button class="btn-primary" id="inputOkBtn">OK</button>
                </div>
            </div>
        </div>

        <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 11px; color: #666; line-height: 1.4;">
            <p><strong>MIT License</strong></p>
            <p>FV-1 Sandbox Editor by Disaster Area Designs, <a href="https://github.com/DisasterAreaDesigns/Sandbox-FV1" style="color: #666;">https://github.com/DisasterAreaDesigns/Sandbox-FV1</a><br>
                Copyright (c) 2025-present by Disaster Area Designs LLC</p>
            <p>Uses portions of asfv1 by Nathan Fraser, <a href="https://github.com/ndf-zz/asfv1" style="color: #666;">https://github.com/ndf-zz/asfv1</a><br>
                Copyright (c) 2017-2021 Nathan Fraser</p>
            <p>Uses monaco-editor by Microsoft, <a href="https://github.com/microsoft/monaco-editor" style="color: #666;">https://github.com/microsoft/monaco-editor</a><br>
                Copyright (c) 2016-present Microsoft Corporation</p>
            <p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
                SOFTWARE.</p>
            <p>This web application stores user settings on this computer in local storage. We don't collect information or any personal data from our users.</p>
        </footer>

        <script>

            // Toggle functions for new sections
            function toggleEditorOptions() {
                const editorOptionsContent = document.getElementById('editorOptionsContent');
                const editorOptionsToggle = document.getElementById('editorOptionsToggle');

                if (editorOptionsContent.classList.contains('collapsed')) {
                    editorOptionsContent.classList.remove('collapsed');
                    editorOptionsToggle.textContent = '▼';
                } else {
                    editorOptionsContent.classList.add('collapsed');
                    editorOptionsToggle.textContent = '▶';
                }
            }

            function toggleHardwareOptions() {
                const hardwareOptionsContent = document.getElementById('hardwareOptionsContent');
                const hardwareOptionsToggle = document.getElementById('hardwareOptionsToggle');

                if (hardwareOptionsContent.classList.contains('collapsed')) {
                    hardwareOptionsContent.classList.remove('collapsed');
                    hardwareOptionsToggle.textContent = '▼';
                } else {
                    hardwareOptionsContent.classList.add('collapsed');
                    hardwareOptionsToggle.textContent = '▶';
                }
            }

            // Download plain HEX function to match FXCore interface
            async function downloadPlainHex() {
                if (!assembledData) {
                    debugLog('No assembled data available', 'errors');
                    return false;
                }

                const hex = document.getElementById('output').value;
                
                if (!hex || hex.trim() === '') {
                    debugLog('No hex data to download', 'errors');
                    return false;
                }

                let defaultFilename = 'fv1_output.hex';
                
                // Try to use File System Access API first
                if ('showSaveFilePicker' in window) {
                    try {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: defaultFilename,
                            types: [{
                                description: 'Intel HEX files',
                                accept: {
                                    'application/octet-stream': ['.hex']
                                }
                            }]
                        });
                        
                        const writable = await fileHandle.createWritable();
                        await writable.write(hex);
                        await writable.close();
                        
                        debugLog('HEX file saved: ' + fileHandle.name, 'success');
                        return true;
                        
                    } catch (err) {
                        if (err.name === 'AbortError') {
                            return false; // User cancelled
                        } else {
                            debugLog('Error saving with file picker: ' + err.message, 'errors');
                            // Fall back to blob download
                        }
                    }
                }
                
                // Fallback for browsers that don't support File System Access API
                const browserSupported = await showConfirmDialog(
                    'Download HEX File', 
                    'Your browser doesn\'t support the advanced file picker. The file will be downloaded to your default downloads folder. Continue?'
                );
                
                if (!browserSupported) return false;
                
                // Always download as file (no hardware interaction)
                downloadFile(defaultFilename, hex, 'application/octet-stream');
                debugLog(`File downloaded as ${defaultFilename} to default downloads folder`, 'success');
                return true;
            }

            // Update hardware connection status
            function updateHardwareConnectionStatus() {
                const statusElement = document.getElementById('hardwareConnectionStatus');
                if (!statusElement) return;

                let statusText = 'No connection';
                let statusColor = '#666';

                // Check file mode connection (output directory)
                if (outputDirectoryHandle) {
                    const filenameSelected = selectedFilename !== null;
                    const slotDisplay = filenameSelected ? selectedFilename.replace('.hex', '') : 'none';
                    statusText = `Directory: ${outputDirectoryHandle.name}, Slot: ${slotDisplay}`;
                    statusColor = '#28a745'; // Green
                } else {
                    const slotDisplay = selectedFilename ? selectedFilename.replace('.hex', '') : 'none';
                    statusText = `No directory, Slot: ${slotDisplay}`;
                }

                statusElement.textContent = statusText;
                statusElement.style.color = statusColor;
            }

            // Initialize the FV-1 assembler when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                DEBUG.reset();
                
                // Add event listener for file input change
                // document.getElementById('fileInput').addEventListener('change', loadFile);

                // Add hidden checkboxes that the assembler expects
                const hiddenCheckboxes = document.createElement('div');
                hiddenCheckboxes.style.display = 'none';
                hiddenCheckboxes.innerHTML = `
                    <input type="checkbox" id="clampOption">
                    <input type="checkbox" id="spinRealsOption">
                `;
                document.body.appendChild(hiddenCheckboxes);

                // Select "3.hex" by default
                const defaultButton = document.querySelector('.filename-btn[data-filename="3.hex"]');
                if (defaultButton) {
                    selectFilename(defaultButton);
                }

                updateHardwareConnectionStatus();

                // Initialize user preferences
                initializePreferences();

                DEBUG.showConfig();

                debugLog('FV-1 assembler libraries loaded', 'info');
            });
        </script>
        <script src="examples.js"></script>
        <script src="assembler.js"></script>
        <script src="debug_config.js"></script>
        <script src="ui.js"></script>
        <script src="user-preferences.js"></script>
    </div>
</body>

</html>